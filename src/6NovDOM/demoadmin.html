<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>

<body class="bg-gray-100">
    <main class="container mx-auto">
        <h1 class="py-2 font-semibold text-center text-2xl">User Information</h1>
        <form action="#" class="bg-white p-6 rounded-md shadow-md" id="adminForm">
            <div class="grid grid-cols-2 gap-1">
                <div>
                    <label for="fname" class="block text-sm font-medium text-gray-600">First Name:</label>
                    <input type="text" name="fname" id="fname" maxlength="15"
                        class="mt-1 p-2 block w-full border rounded-md">
                    <span id="fnameError" class="text-red-500"></span>
                </div>
                <div>
                    <label for="lname" class="block text-sm font-medium text-gray-600">Last Name:</label>
                    <input type="text" name="lname" id="lname" maxlength="15"
                        class="mt-1 p-2 block w-full border rounded-md">
                    <span id="lnameError" class="text-red-500"></span>
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-600">Age:</label>
                    <input type="number" id="age" name="age" required class="mt-1 p-2 block w-full border rounded-md">
                    <span id="ageError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-600">Gender:</label>
                    <select id="gender" name="gender" required class="mt-1 p-2 block w-full border rounded-md">
                        <option value="" disabled selected>Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <span id="genderError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-600">Email:</label>
                    <input type="email" id="email" name="email" required
                        class="mt-1 p-2 block w-full border rounded-md">
                    <span id="emailError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-600">Date of Birth:</label>
                    <input type="date" id="dob" name="dob" required class="mt-1 p-2 block w-full border rounded-md">
                    <span id="dobError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="bloodGroup" class="block text-sm font-medium text-gray-600">Blood Group:</label>
                    <input type="text" id="bloodGroup" name="bloodGroup" required
                        class="mt-1 p-2 block w-full border rounded-md">
                    <span id="bloodGroupError" class="text-red-500"></span>
                </div>

                <div class="relative">
                    <div>
                        <img src="https://media.istockphoto.com/id/1337144146/vector/default-avatar-profile-icon-vector.jpg?s=612x612&w=0&k=20&c=BIbFwuv7FxTWvh5S3vB6bkT0Qv8Vn8N5Ffseq84ClGI="
                            alt="userimg" id="userimage" class="h-16 w-16 absolute right-0 -bottom-2 rounded-full">
                    </div>
                    <label for="image" class="block text-sm font-medium text-gray-600">Image:</label>
                    <input type="file" id="image" name="image" accept="image/*"
                        class="mt-1 p-2 block w-3/4  border rounded-md">
                    <span id="imageError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-600">Enter Password</label>
                    <input type="password" id="password" name="password"
                        class="mt-1 p-2 block w-full  border rounded-md" required>
                    <div>
                        <input type="checkbox" id="showpassword" class="my-3">
                        <label for="showpassword" class="text-sm font-medium text-gray-600">Show Password</label>
                    </div>
                    <span id="passwordError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="password2" class="block text-sm font-medium text-gray-600">Confirm Password</label>
                    <input type="password" id="password2" name="password2"
                        class="mt-1 p-2 block w-full  border rounded-md" required>
                    <span id="password2Error" class="text-red-500"></span>

                </div>

                <div>
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-600">Phone Number:</label>
                    <input type="tel" id="phoneNumber" name="phoneNumber" required
                        class="mt-1 p-2 block w-full border rounded-md">
                    <span id="phoneNumberError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="role" class="block text-sm font-medium text-gray-600">Roles:</label>
                    <select id="role" name="role" required class="mt-1 p-2 block w-full border rounded-md">
                        <option value="" disabled selected>Select role</option>
                        <option value="Employee">Employee</option>
                        <option value="HR">HR</option>
                        <option value="Team Leader">Team Leader</option>
                    </select>
                    <span id="roleError" class="text-red-500"></span>
                </div>

                <div>
                    <label for="currentAddress" class="block text-sm font-medium text-gray-600">Current Address:</label>
                    <textarea id="currentAddress" name="currentAddress" required
                        class="mt-1 p-2 block w-full border rounded-md"></textarea>
                    <span id="currentAddressError" class="text-red-500"></span>
                    <div>
                        <input type="checkbox" id="copyAddress">
                        <label for="copyAddress" class="text-sm font-medium text-gray-600">Current Address same as
                            Permanent
                            Address</label>
                    </div>
                </div>

                <div>
                    <label for="permanentAddress" class="block text-sm font-medium text-gray-600">Permanent
                        Address:</label>
                    <textarea id="permanentAddress" name="permanentAddress" required
                        class="mt-1 p-2 block w-full border rounded-md"></textarea>
                    <span id="permanentAddressError" class="text-red-500"></span>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="button" id="btn"
                    class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Submit</button>
            </div>

        </form>
    </main>
    <script>

        const user = {

            submit: document.querySelector("#btn"),
            fname: document.getElementById('fname'),
            lname: document.getElementById('lname'),
            age: document.getElementById('age'),
            gender: document.getElementById('gender'),
            email: document.getElementById('email'),
            dob: document.getElementById('dob'),
            bloodGroup: document.getElementById('bloodGroup'),
            image: document.getElementById('image'),
            phoneNumber: document.getElementById('phoneNumber'),
            role: document.getElementById('role'),
            currentAddress: document.getElementById('currentAddress'),
            permanentAddress: document.getElementById('permanentAddress'),
            form: document.getElementById('adminForm'),
            copyAddressCheckbox: document.getElementById('copyAddress'),
            password: document.getElementById('password'),
            confirmPassword: document.getElementById('password2'),
            showPassword: document.getElementById('showpassword'),
            formDataArray: JSON.parse(localStorage.getItem('adminFormData')) || [],

            updateLocalStorage: function () {
                localStorage.setItem('adminFormData', JSON.stringify(this.formDataArray));
            },

            submitForm: async function () {
                const id = new URLSearchParams(location.search).get('id')
                const existingDataIndex = this.formDataArray.findIndex(item => (item.id) == id);

                if (this.fname.value.trim() === '') {
                    fnameError.innerHTML = 'First Name is required';
                }
                if (this.lname.value.trim() === '') {
                    lnameError.innerHTML = 'Last Name is required';
                }
                if (this.age.value === '') {
                    ageError.innerHTML = 'Age is required';
                }
                if (this.gender.value === '') {
                    genderError.innerHTML = 'Select gender';
                }
                if (this.email.value === '') {
                    emailError.innerHTML = 'Please Enter email';
                }
                if (this.dob.value === '') {
                    dobError.innerHTML = 'Please select DOB'
                }
                if (this.role.value === '') {
                    roleError.innerHTML = 'Please select Role'
                }
                if (this.bloodGroup.value === "") {
                    bloodGroupError.innerHTML = "Please enter blood group";
                }

                let imageFile = this.image.files[0];
                if (!imageFile && !id) {
                    imageError.innerHTML = 'Please select an image file.';
                }

                if (this.password.value === "") {
                    passwordError.innerHTML = "Enter Password";
                }

                if (this.confirmPassword.value === "") {
                    password2Error.innerHTML = "Enter Password";
                }

                if (this.phoneNumber.value === "") {
                    phoneNumberError.innerHTML = "Enter Phone number";
                }

                if (this.currentAddress.value === "") {
                    currentAddressError.innerHTML = "Fill address";
                }
                if (this.permanentAddress.value === "") {
                    permanentAddressError.innerHTML = "Fill address";
                }

                if (!fnameError.innerHTML && !lnameError.innerHTML && !ageError.innerHTML &&
                    !genderError.innerHTML && !emailError.innerHTML && !dobError.innerHTML &&
                    !bloodGroupError.innerHTML && !imageError.innerHTML && !phoneNumberError.innerHTML &&
                    !currentAddressError.innerHTML && !permanentAddressError.innerHTML && !roleError.innerHTML && !passwordError.innerHTML && !password2Error.innerHTML) {

                    const formData = new FormData(this.form);

                    let formDataObject = { id: Date.now() };

                    for (const [key, value] of formData.entries()) {
                        console.log(key, value);

                        if (value instanceof File) {
                            if (value.size > 0) {
                                try {
                                    const result = await this.readFile(value);
                                    formDataObject[key] = result;
                                } catch (error) {
                                    console.error("Error reading file:", error);
                                }
                            } else {
                                formDataObject[key] = null
                                if (id && key === 'image') {
                                    console.log(existingDataIndex);
                                    formDataObject[key] = user.formDataArray[existingDataIndex].image;
                                }
                            }
                        } else {
                            if (id && key === 'image') {
                                formDataObject[key] = this.formDataArray[existingDataIndex].image
                                console.log(formDataObject);
                            }
                            else {
                                formDataObject[key] = value;
                            }
                        }
                    }

                    if (existingDataIndex !== -1) {
                        // Update existing data
                        this.formDataArray[existingDataIndex] = formDataObject;

                    } else {
                        // Add new form data userect into the array
                        this.formDataArray.push(formDataObject);
                    }

                    // Store the array in local storage
                    this.updateLocalStorage()
                    alert('Data saved sucessfully');
                    window.location.href = 'http://127.0.0.1:5500/src/6NovDOM/tableForm.html';
                    this.form.reset();
                }

            },

            handleCheckboxState: function () {
                let permanentAddress = this.permanentAddress;

                this.copyAddressCheckbox.addEventListener('change', function () {
                    if (user.copyAddressCheckbox.checked) {
                        permanentAddress.innerHTML = currentAddress.value;
                    }
                });

                this.showPassword.addEventListener('click', function () {

                    if (user.password.type === "password") {
                        user.password.type = "text";
                    } else {
                        user.password.type = "password";
                    }
                })


            },

            populateFormData: function () {
                const storedDataJSON = localStorage.getItem('adminFormData');
                const storedData = JSON.parse(storedDataJSON) ? JSON.parse(storedDataJSON) : [];
                const imageElement = document.getElementById('userimage');

                storedData.forEach((element, itemIndex) => {
                    if (element.id == new URLSearchParams(location.search).get('id')) {
                        this.fname.value = element.fname;
                        this.lname.value = element.lname;
                        this.age.value = element.age;
                        this.gender.value = element.gender;
                        this.email.value = element.email;
                        this.dob.value = element.dob;
                        this.bloodGroup.value = element.bloodGroup;
                        this.phoneNumber.value = element.phoneNumber;
                        this.role.value = element.role;
                        this.currentAddress.value = element.currentAddress;
                        this.permanentAddress.value = element.permanentAddress;
                        this.password.value = element.password;
                        this.confirmPassword.value = element.confirmPassword;
                        imageElement.src = element.image || 'https://media.istockphoto.com/id/1337144146/vector/default-avatar-profile-icon-vector.jpg?s=612x612&w=0&k=20&c=BIbFwuv7FxTWvh5S3vB6bkT0Qv8Vn8N5Ffseq84ClGI=';
                    }
                });
            },

            validations: function () {

                const fnameError = document.getElementById('fnameError');
                const lnameError = document.getElementById('lnameError');
                const ageError = document.getElementById('ageError');
                const genderError = document.getElementById('genderError');
                const emailError = document.getElementById('emailError');
                const dobError = document.getElementById('dobError');
                const bloodGroupError = document.getElementById('bloodGroupError');
                const imageError = document.getElementById('imageError');
                const phoneNumberError = document.getElementById('phoneNumberError');
                const roleError = document.getElementById('roleError');
                const currentAddressError = document.getElementById('currentAddressError');
                const permanentAddressError = document.getElementById('permanentAddressError');
                const passwordError = document.getElementById('passwordError');
                const password2Error = document.getElementById('password2Error');

                let today = new Date();

                this.fname.addEventListener("input", () => {

                    if (!/^[a-zA-Z]+$/.test(this.fname.value)) {
                        fnameError.innerHTML = 'First Name should contain only alphabets.';
                    }
                    if (this.fname.value === "" || /^[a-zA-Z]+$/.test(this.fname.value)) {
                        fnameError.innerHTML = '';
                    }
                })

                this.lname.addEventListener("input", () => {

                    if (!/^[a-zA-Z]+$/.test(this.lname.value)) {
                        lnameError.innerHTML = 'Last Name should contain only alphabets.';
                    }

                    if (this.lname.value === "" || /^[a-zA-Z]+$/.test(this.lname.value)) {
                        lnameError.innerHTML = '';
                    }
                })

                this.age.addEventListener("input", () => {
                    let ageValue = this.age.value;

                    if (ageValue < 18) {
                        ageError.innerHTML = 'Age must be a number greater than 18.';
                    }
                    if (ageValue === "" || ageValue > 18) {
                        ageError.innerHTML = '';
                    }
                });

                this.gender.addEventListener("input", () => {
                    if (gender.value !== '') {
                        genderError.innerHTML = '';
                    }
                })

                this.email.addEventListener("input", () => {
                    let emailValue = this.email.value;

                    const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;

                    if (!emailRegex.test(emailValue)) {
                        emailError.innerHTML = 'Please enter a valid email address.';
                    }
                    if (emailValue === "" || emailRegex.test(emailValue)) {
                        emailError.innerHTML = '';
                    }
                });

                this.password.addEventListener("input", () => {
                    let passwordValue = this.password.value;
                    let regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@.#$!%*?&^])[A-Za-z\d@.#$!%*?&]{8,15}$/;

                    if (!regex.test(passwordValue)) {
                        passwordError.innerHTML = "Min eight characters, at least one letter, number , speacial character.";
                    }
                    if (regex.test(passwordValue) || passwordValue === "") {
                        passwordError.innerHTML = "";
                    }

                })

                this.confirmPassword.addEventListener("input", () => {
                    let password2Value = this.confirmPassword.value;
                    let passwordValue = this.password.value;

                    if (password2Value !== passwordValue) {
                        password2Error.innerHTML = "your password does not matched";
                    }
                    if (password2Value === passwordValue) {
                        password2Error.innerHTML = "";
                    }

                })

                this.dob.addEventListener("input", () => {
                    const selectedDate = new Date(this.dob.value);

                    if (selectedDate > today) {
                        dobError.innerHTML = "Invalid date of birth";
                    }
                    if (selectedDate < today) {
                        dobError.innerHTML = "";
                    }

                });

                this.role.addEventListener("input", () => {

                    if (this.role.value !== "") {
                        roleError.innerHTML = "";
                    }

                });

                this.bloodGroup.addEventListener("input", () => {
                    let bloodGroupValue = this.bloodGroup.value;

                    const validBloodGroups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];

                    if (!validBloodGroups.includes(bloodGroupValue.toUpperCase())) {
                        bloodGroupError.innerHTML = 'Please enter a valid blood group (e.g., A+, B-, O-).';
                    }
                    if (bloodGroupValue === "" || validBloodGroups.includes(bloodGroupValue.toUpperCase())) {
                        bloodGroupError.innerHTML = '';
                    }
                });

                this.image.addEventListener("change", (e) => {
                    let imageFile = this.image.files;

                    if (imageFile) {
                        imageError.innerHTML = '';
                    }

                });



                this.phoneNumber.addEventListener("input", () => {
                    let phoneNumberValue = this.phoneNumber.value;

                    // Regular expression for a valid Indian phone number
                    const phoneRegex = /^[6-9]\d{9}$/;

                    if (!phoneRegex.test(phoneNumberValue)) {
                        phoneNumberError.innerHTML = 'Please enter a valid Indian phone number.';
                    }
                    if (phoneNumberValue === "" || phoneRegex.test(phoneNumberValue)) {
                        phoneNumberError.innerHTML = '';
                    }
                });

                this.currentAddress.addEventListener("input", () => {
                    if (currentAddress.value !== "") {
                        currentAddressError.innerHTML = "";
                    }
                });

                this.permanentAddress.addEventListener("input", () => {
                    if (permanentAddress.value !== "") {
                        permanentAddressError.innerHTML = "";
                    }
                });

                this.handleCheckboxState();
                this.populateFormData();

            }
        }

        user.validations();

        document.querySelector("#btn").addEventListener("click", function () {
            user.submitForm();
        });

        user.form.addEventListener('submit', (e) => {
            e.preventDefault();
        });

    </script>
</body>

</html>